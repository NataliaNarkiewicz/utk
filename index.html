<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RGB Lamp Controller Bluetooth</title>

<style>
body { background:#111; color:white; font-family:Arial; margin:0 }
header { background:#222; padding:1rem; text-align:center; font-size:1.5rem }
nav { display:flex; justify-content:center; background:#333; flex-wrap:wrap }
nav button { background:none; border:none; color:#ccc; padding:1rem 2rem; cursor:pointer }
nav button.active { background:#555; color:white }
main { padding:1rem }

section { display:none }

#grid {
  display:grid;
  grid-template-columns:repeat(9,40px);
  gap:4px;
  justify-content:center;
}

.cell {
  width:40px;
  height:40px;
  background:black;
  border-radius:4px;
  cursor:pointer;
}

.color-circle {
  width:35px;
  height:35px;
  border-radius:50%;
  display:inline-block;
  margin:5px;
  cursor:pointer;
  border:3px solid transparent;
}
.color-circle.selected { border-color:yellow }

button { padding:0.5rem 1rem; margin:5px; background:#444; color:white; border:none; border-radius:4px }
input[type=range]{ margin:5px; }
</style>
</head>

<body>

<header>RGB Lamp Controller Bluetooth</header>

<nav>
<button id="btnConnect" class="active">PoÅ‚Ä…czenie</button>
<button id="btnGrid">Siatka LED</button>
<button id="btnMusic">Muzyka</button>
<button id="btnMods">Mody</button>
<button id="btnVoice">GÅ‚os</button>
<button id="btnBrightness">JasnoÅ›Ä‡</button>
</nav>

<main>

<section id="connectionPage">
<button id="btnRequestBluetooth">PoÅ‚Ä…cz Bluetooth</button>
<p id="connStatus">Nie poÅ‚Ä…czono</p>
</section>

<section id="gridPage">
<div>
<div class="color-circle selected" id="red" style="background:red"></div>
<div class="color-circle" id="green" style="background:green"></div>
<div class="color-circle" id="blue" style="background:blue"></div>
<div class="color-circle" id="yellow" style="background:yellow"></div>
<div class="color-circle" id="purple" style="background:purple"></div>
<div class="color-circle" id="orange" style="background:orange"></div>
<div class="color-circle" id="pink" style="background:pink"></div>
</div>

<div id="grid"></div>
<button id="btnSendGrid">WyÅ›lij do lampy</button>
<button id="btnClearGrid">WyczyÅ›Ä‡</button>
<p id="sendStatus"></p>
</section>

<section id="musicPage">
<p>Mod muzyczny (do rozbudowy)</p>
</section>

<section id="modsPage">
<h3>Efekty LED</h3>
<button onclick="startBlink()">Miganie</button>
<button onclick="startRainbow()">TÄ™cza</button>
<button onclick="startPulse()">Pulsowanie</button>
<button onclick="startRandom()">Losowe</button>
<button onclick="stopEffects()">Stop</button>
</section>

<section id="voicePage">
<h3>Sterowanie gÅ‚osem ðŸŽ¤</h3>
<button id="btnVoiceStart">Start nasÅ‚uchiwania</button>
<button id="btnVoiceStop">Stop nasÅ‚uchiwania</button>
<p id="voiceStatus">Nieaktywny</p>
</section>

<section id="brightnessPage">
<h3>Regulacja jasnoÅ›ci</h3>
<input type="range" id="brightnessSlider" min="0" max="255" value="255">
<p id="brightnessValue">255</p>
</section>

</main>

<script>
const NUM_LEDS = 81;
let brightness = 255;
const colors = {
  red:[255,0,0],
  green:[0,255,0],
  blue:[0,0,255],
  yellow:[255,255,0],
  orange:[255,165,0],
  purple:[128,0,128],
  pink:[255,20,147],
  black:[0,0,0]
};

let writeCharacteristic = null;
let cells = [];
let selectedColor = 'red';
let effectInterval = null;

/* ---------- NAWIGACJA ---------- */
const pages = {
  btnConnect:'connectionPage',
  btnGrid:'gridPage',
  btnMusic:'musicPage',
  btnMods:'modsPage',
  btnVoice:'voicePage',
  btnBrightness:'brightnessPage'
};

Object.keys(pages).forEach(id=>{
  document.getElementById(id).onclick=()=>{
    document.querySelectorAll('section').forEach(s=>s.style.display='none');
    document.getElementById(pages[id]).style.display='block';
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
});
document.getElementById('connectionPage').style.display='block';

/* ---------- BLUETOOTH ---------- */
const SERVICE_UUID='12345678-1234-1234-1234-1234567890ab';
const CHAR_UUID='87654321-4321-4321-4321-0987654321ba';

document.getElementById('btnRequestBluetooth').onclick=async()=>{
  try {
    const device=await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[SERVICE_UUID]
    });
    const server=await device.gatt.connect();
    const service=await server.getPrimaryService(SERVICE_UUID);
    writeCharacteristic=await service.getCharacteristic(CHAR_UUID);
    document.getElementById('connStatus').textContent="PoÅ‚Ä…czono!";
  } catch(e){
    document.getElementById('connStatus').textContent="BÅ‚Ä…d: "+e.message;
  }
};

/* ---------- GRID ---------- */
const grid=document.getElementById('grid');
for(let i=0;i<NUM_LEDS;i++){
  const c=document.createElement('div');
  c.className='cell';
  c.onclick=()=>c.style.background=`rgb(${colors[selectedColor][0]*brightness/255|0},${colors[selectedColor][1]*brightness/255|0},${colors[selectedColor][2]*brightness/255|0})`;
  grid.appendChild(c);
  cells.push(c);
}

document.querySelectorAll('.color-circle').forEach(c=>{
  c.onclick=()=>{
    document.querySelectorAll('.color-circle').forEach(x=>x.classList.remove('selected'));
    c.classList.add('selected');
    selectedColor=c.id;
  };
});

document.getElementById('btnSendGrid').onclick=sendGrid;
document.getElementById('btnClearGrid').onclick=clearGrid;

function sendGrid(){
  if(!writeCharacteristic) return;
  let data=new Uint8Array(NUM_LEDS*3);
  cells.forEach((c,i)=>{
    let rgb=c.style.background.match(/\d+/g).map(Number);
    data.set(rgb,i*3);
  });
  writeCharacteristic.writeValue(data);
}

function clearGrid(){
  cells.forEach(c=>{
    c.style.background='rgb(0,0,0)';
  });
  sendGrid();
}

/* ---------- MODY ---------- */
function stopEffects(){ clearInterval(effectInterval); }

function fill(color){
  const col = colors[color].map(v=>v*brightness/255|0);
  cells.forEach(c=>c.style.background=`rgb(${col})`);
  sendGrid();
}

function startBlink(){
  stopEffects();
  let on=true;
  effectInterval=setInterval(()=>{
    fill(on?'red':'black');
    on=!on;
  },500);
}

function startRainbow(){
  stopEffects();
  let cols=Object.keys(colors);
  let i=0;
  effectInterval=setInterval(()=>fill(cols[i++%cols.length]),300);
}

function startPulse(){
  stopEffects();
  let v=0,dir=1;
  effectInterval=setInterval(()=>{
    let col=[v,0,255-v].map(x=>x*brightness/255|0);
    cells.forEach(c=>c.style.background=`rgb(${col})`);
    sendGrid();
    v+=dir*15;
    if(v>=255||v<=0) dir*=-1;
  },100);
}

function startRandom(){
  stopEffects();
  effectInterval=setInterval(()=>{
    cells.forEach(c=>{
      let r=Math.random()*255|0;
      let g=Math.random()*255|0;
      let b=Math.random()*255|0;
      r=r*brightness/255|0; g=g*brightness/255|0; b=b*brightness/255|0;
      c.style.background=`rgb(${r},${g},${b})`;
    });
    sendGrid();
  },300);
}

/* ---------- GÅOS ---------- */
const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
const recog=new SpeechRecognition();
recog.lang='pl-PL';
recog.continuous=true;
recog.interimResults=true;

recog.onresult=e=>{
  const text=e.results[e.results.length-1][0].transcript.toLowerCase();
  document.getElementById('voiceStatus').textContent=text;

  if(text.includes('czerw')) fill('red');
  else if(text.includes('niebies')) fill('blue');
  else if(text.includes('zielon')) fill('green');
  else if(text.includes('Å¼Ã³Å‚')) fill('yellow');
  else if(text.includes('pomara')) fill('orange');
  else if(text.includes('fiolet')) fill('purple');
  else if(text.includes('rÃ³Å¼')) fill('pink');
};

/* Automatyczny restart po zakoÅ„czeniu, Å¼eby dziaÅ‚aÅ‚o ciÄ…gle */
recog.onend = () => {
  if(document.getElementById('btnVoiceStart').disabled) return;
  recog.start();
};

/* Start / Stop nasÅ‚uchiwania */
document.getElementById('btnVoiceStart').onclick=async()=>{
  try{
    await navigator.mediaDevices.getUserMedia({audio:true});
    recog.start();
    document.getElementById('btnVoiceStart').disabled = true;
    document.getElementById('btnVoiceStop').disabled = false;
    document.getElementById('voiceStatus').textContent="NasÅ‚uchiwanie...";
  } catch(e){
    document.getElementById('voiceStatus').textContent="BÅ‚Ä…d mikrofonu: "+e.message;
  }
};

document.getElementById('btnVoiceStop').onclick=()=>{
  recog.stop();
  document.getElementById('btnVoiceStart').disabled = false;
  document.getElementById('btnVoiceStop').disabled = true;
  document.getElementById('voiceStatus').textContent="Zatrzymano nasÅ‚uchiwanie";
};

/* ---------- JASNOÅšÄ† ---------- */
const brightnessSlider=document.getElementById('brightnessSlider');
const brightnessValue=document.getElementById('brightnessValue');
brightnessSlider.oninput=()=>{
  brightness=Number(brightnessSlider.value);
  brightnessValue.textContent=brightness;
  // Aktualizuj aktualny kolor w gridzie
  cells.forEach(c=>{
    let rgb=c.style.background.match(/\d+/g).map(Number);
    c.style.background=`rgb(${rgb.map(x=>x*brightness/255|0)})`;
  });
};
</script>

</body>
  </html>

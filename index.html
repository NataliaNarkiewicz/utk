<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RGB Lamp Controller Voice + Grid</title>
<style>
body { background:#111; color:white; font-family:Arial; margin:0; transition:background 0.3s; }
header { background:#222; padding:1rem; text-align:center; font-size:1.5rem }
nav { display:flex; justify-content:center; background:#333; flex-wrap:wrap }
nav button { background:none; border:none; color:#ccc; padding:1rem 2rem; cursor:pointer }
nav button.active { background:#555; color:white }
main { padding:1rem }
section { display:none }
#grid { display:grid; grid-template-columns:repeat(9,40px); gap:4px; justify-content:center; margin-top:10px; }
.cell { width:40px; height:40px; background:black; border-radius:4px; cursor:pointer; }
button { padding:0.5rem 1rem; margin:5px; background:#444; color:white; border:none; border-radius:4px }
</style>
</head>
<body>

<header>RGB Lamp Controller Voice + Grid</header>

<nav>
<button id="btnConnect" class="active">PoÅ‚Ä…czenie</button>
<button id="btnVoice">GÅ‚os</button>
</nav>

<main>
<section id="connectionPage">
<button id="btnRequestBluetooth">PoÅ‚Ä…cz Bluetooth</button>
<p id="connStatus">Nie poÅ‚Ä…czono</p>
</section>

<section id="voicePage">
<h3>Sterowanie gÅ‚osem ðŸŽ¤</h3>
<button id="btnVoiceStart">Start nasÅ‚uchiwania</button>
<button id="btnVoiceStop" disabled>Stop nasÅ‚uchiwania</button>
<p id="voiceStatus">Nieaktywny</p>
<p id="voiceColorText" style="font-size:1.5rem;font-weight:bold;margin-top:10px;"></p>
<div id="grid"></div>
<button id="btnSendGrid">WyÅ›lij do lampy</button>
</section>
</main>

<script>
const NUM_LEDS = 81;
let brightness = 255;
let writeCharacteristic = null;
let cells = [];
let currentColor = null;

const colors = {
red:[255,0,0],
green:[0,255,0],
blue:[0,0,255],
yellow:[255,255,0],
orange:[255,165,0],
purple:[128,0,128],
pink:[255,20,147],
black:[0,0,0]
};

const colorMap = {
"czerwony":"red","czerwona":"red",
"zielony":"green","zielona":"green",
"niebieski":"blue","niebieska":"blue",
"Å¼Ã³Å‚ty":"yellow","zolty":"yellow",
"fioletowy":"purple",
"rÃ³Å¼owy":"pink","rozowy":"pink",
"pomaraÅ„czowy":"orange","pomaranczowy":"orange"
};

/* ---------- NAWIGACJA ---------- */
const pages = {btnConnect:'connectionPage', btnVoice:'voicePage'};
Object.keys(pages).forEach(id=>{
  document.getElementById(id).onclick=()=>{
    document.querySelectorAll('section').forEach(s=>s.style.display='none');
    document.getElementById(pages[id]).style.display='block';
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
});
document.getElementById('connectionPage').style.display='block';

/* ---------- BLUETOOTH ---------- */
const SERVICE_UUID='12345678-1234-1234-1234-1234567890ab';
const CHAR_UUID='87654321-4321-4321-4321-0987654321ba';

document.getElementById('btnRequestBluetooth').onclick=async()=>{
  try{
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[SERVICE_UUID]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    writeCharacteristic = await service.getCharacteristic(CHAR_UUID);
    document.getElementById('connStatus').textContent="PoÅ‚Ä…czono z "+device.name;
  }catch(e){
    document.getElementById('connStatus').textContent="BÅ‚Ä…d: "+e.message;
  }
};

/* ---------- GRID ---------- */
const grid=document.getElementById('grid');
for(let i=0;i<NUM_LEDS;i++){
  const c=document.createElement('div');
  c.className='cell';
  c.dataset.baseColor='0,0,0';
  grid.appendChild(c);
  cells.push(c);
}

/* WypeÅ‚nienie siatki kolorem */
function fill(color){
  const rgb=colors[color];
  cells.forEach(c=>{
    c.dataset.baseColor=rgb.join(',');
    const scaled = rgb.map(v=>v*brightness/255|0);
    c.style.background=`rgb(${scaled[0]},${scaled[1]},${scaled[2]})`;
  });
  currentColor = color;
}

/* WysyÅ‚anie koloru do ESP32 */
async function sendGrid(){
  if(!writeCharacteristic){ alert("Najpierw poÅ‚Ä…cz z ESP32!"); return; }
  if(!currentColor){ alert("Nie wybrano koloru!"); return; }
  const rgb = colors[currentColor];
  let data = new Uint8Array(NUM_LEDS*3);
  for(let i=0;i<NUM_LEDS;i++){
    data[i*3]=rgb[0];
    data[i*3+1]=rgb[1];
    data[i*3+2]=rgb[2];
  }
  await writeCharacteristic.writeValue(data);
  alert("WysÅ‚ano kolor: "+currentColor);
}

/* ---------- GÅOS ---------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog=null, isListening=false;

if(SpeechRecognition){
  recog=new SpeechRecognition();
  recog.lang='pl-PL';
  recog.continuous=true;
  recog.interimResults=false;

  recog.onresult=e=>{
    const transcript=e.results[e.resultIndex][0].transcript.toLowerCase().trim();
    document.getElementById('voiceStatus').textContent="Rozpoznano: "+transcript;
    document.getElementById('voiceColorText').textContent=transcript;
    let detected=null;
    Object.keys(colorMap).forEach(key=>{ if(transcript.includes(key)) detected=colorMap[key]; });
    if(detected){
      fill(detected);
      document.body.style.backgroundColor=detected;
    }
  };

  recog.onerror=e=>{ document.getElementById('voiceStatus').textContent="BÅ‚Ä…d: "+e.error; };
  recog.onend=()=>{ if(isListening){ try{ recog.start(); }catch(e){} } };

  document.getElementById('btnVoiceStart').onclick=async()=>{
    try{
      await navigator.mediaDevices.getUserMedia({audio:true});
      isListening=true;
      recog.start();
      document.getElementById('btnVoiceStart').disabled=true;
      document.getElementById('btnVoiceStop').disabled=false;
      document.getElementById('voiceStatus').textContent="NasÅ‚uchiwanie...";
    }catch(e){ document.getElementById('voiceStatus').textContent="BÅ‚Ä…d mikrofonu: "+e.message; }
  };

  document.getElementById('btnVoiceStop').onclick=()=>{
    isListening=false;
    try{ recog.stop(); }catch(e){}
    document.getElementById('btnVoiceStart').disabled=false;
    document.getElementById('btnVoiceStop').disabled=true;
    document.getElementById('voiceStatus').textContent="Zatrzymano nasÅ‚uchiwanie";
  };
}else{
  document.getElementById('voiceStatus').textContent="Brak obsÅ‚ugi Web Speech API (Chrome)";
}

/* ---------- WYÅšLIJ ---------- */
document.getElementById('btnSendGrid').onclick=sendGrid;
</script>
</body>
</html>
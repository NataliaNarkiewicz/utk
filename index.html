<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RGB Lamp Voice Grid</title>
<style>
body { background:#111; color:white; font-family:Arial; margin:0; transition:background 0.3s; }
header { background:#222; padding:1rem; text-align:center; font-size:1.5rem }
nav { display:flex; justify-content:center; background:#333; flex-wrap:wrap }
nav button { background:none; border:none; color:#ccc; padding:1rem 2rem; cursor:pointer }
nav button.active { background:#555; color:white }
main { padding:1rem }
section { display:none }
#grid { display:grid; grid-template-columns:repeat(9,40px); gap:4px; justify-content:center; margin-top:10px; }
.cell { width:40px; height:40px; background:black; border-radius:4px; cursor:pointer; }
button { padding:0.5rem 1rem; margin:5px; background:#444; color:white; border:none; border-radius:4px }
#log { font-size:0.8rem; max-height:120px; overflow:auto; background:#000; padding:0.5rem; margin-top:10px; white-space:pre-wrap; }
</style>
</head>
<body>

<header>RGB Lamp Voice Grid</header>

<nav>
<button id="btnConnect" class="active">Po≈ÇƒÖczenie</button>
<button id="btnVoice">G≈Ços</button>
</nav>

<main>
<section id="connectionPage">
<button id="btnRequestBluetooth">Po≈ÇƒÖcz Bluetooth</button>
<p id="connStatus">Nie po≈ÇƒÖczono</p>
</section>

<section id="voicePage">
<h3>Sterowanie g≈Çosem üé§</h3>
<button id="btnVoiceStart">Start nas≈Çuchiwania</button>
<button id="btnVoiceStop" disabled>Stop nas≈Çuchiwania</button>
<p id="voiceStatus">Nieaktywny</p>
<p id="voiceColorText" style="font-size:1.5rem;font-weight:bold;margin-top:10px;"></p>
<div id="gridContainer"></div>
<button id="btnSendGrid">Wy≈õlij do lampy</button>
<div id="log"></div>
</section>
</main>

<script>
const NUM_LEDS = 81;
let brightness = 255;
let writeCharacteristic = null;
let cells = [];
let currentColor = null;

const colors = {
  red:[255,0,0],
  green:[0,255,0],
  blue:[0,0,255],
  yellow:[255,255,0],
  orange:[255,165,0],
  purple:[128,0,128],
  pink:[255,20,147],
  black:[0,0,0]
};

const colorMap = {
  "czerwony":"red","czerwona":"red",
  "zielony":"green","zielona":"green",
  "niebieski":"blue","niebieska":"blue",
  "≈º√≥≈Çty":"yellow","zolty":"yellow",
  "fioletowy":"purple",
  "r√≥≈ºowy":"pink","rozowy":"pink",
  "pomara≈Ñczowy":"orange","pomaranczowy":"orange",
  "czarny":"black","czarna":"black",
  "r√≥≈º":"pink","roz":"pink"
};

function log(msg){
  console.log(msg);
  const el = document.getElementById('log');
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

/* ---------- NAWIGACJA ---------- */
const pages = {btnConnect:'connectionPage', btnVoice:'voicePage'};
Object.keys(pages).forEach(id=>{
  document.getElementById(id).onclick=()=>{
    document.querySelectorAll('section').forEach(s=>s.style.display='none');
    document.getElementById(pages[id]).style.display='block';
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
});
document.getElementById('connectionPage').style.display='block';

/* ---------- BLUETOOTH ---------- */
const SERVICE_UUID='12345678-1234-1234-1234-1234567890ab';
const CHAR_UUID='87654321-4321-4321-4321-0987654321ba';

document.getElementById('btnRequestBluetooth').onclick=async()=>{
  try{
    log("≈ªƒÖdanie urzƒÖdzenia Bluetooth...");
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[SERVICE_UUID]
    });
    log("Wybrano urzƒÖdzenie: " + device.name);
    const server = await device.gatt.connect();
    log("Po≈ÇƒÖczono z GATT");
    const service = await server.getPrimaryService(SERVICE_UUID);
    writeCharacteristic = await service.getCharacteristic(CHAR_UUID);
    document.getElementById('connStatus').textContent="Po≈ÇƒÖczono z "+device.name;
    log("Gotowa charakterystyka do zapisu");
  }catch(e){
    document.getElementById('connStatus').textContent="B≈ÇƒÖd: "+e.message;
    log("B≈ÇƒÖd Bluetooth: " + e.message);
  }
};

/* ---------- GRID ---------- */
const gridContainer = document.getElementById('gridContainer');
const grid = document.createElement('div');
grid.id = 'grid';
gridContainer.appendChild(grid);

for(let i=0;i<NUM_LEDS;i++){
  const c = document.createElement('div');
  c.className = 'cell';
  c.dataset.baseColor = '0,0,0';
  grid.appendChild(c);
  cells.push(c);
}

function fill(color){
  const rgb = colors[color];
  if(!rgb){
    log("fill(): nieznany kolor: " + color);
    return;
  }
  log("Wype≈Çniam siatkƒô kolorem: " + color + " ("+rgb.join(",")+")");
  cells.forEach(c=>{
    c.dataset.baseColor = rgb.join(',');
    const scaled = rgb.map(v => Math.floor(v*brightness/255));
    c.style.background = `rgb(${scaled[0]},${scaled[1]},${scaled[2]})`;
  });
  currentColor = color;
}

/* ---------- WYSY≈ÅANIE DO ESP32 ---------- */
async function sendGrid(){
  log("Pr√≥ba wys≈Çania siatki...");
  if(!writeCharacteristic){
    alert("Najpierw po≈ÇƒÖcz z ESP32!");
    log("Brak writeCharacteristic ‚Äì nie po≈ÇƒÖczono z ESP32");
    return;
  }
  if(!currentColor){
    alert("Nie wykryto koloru!");
    log("Brak currentColor ‚Äì nic do wys≈Çania");
    return;
  }
  const rgb = colors[currentColor];
  if(!rgb){
    log("Nieznany currentColor: " + currentColor);
    return;
  }
  let data = new Uint8Array(NUM_LEDS*3);
  for(let i=0;i<NUM_LEDS;i++){
    data[i*3] = rgb[0];
    data[i*3+1] = rgb[1];
    data[i*3+2] = rgb[2];
  }
  try{
    await writeCharacteristic.writeValue(data);
    alert("Wys≈Çano kolor: "+currentColor);
    log("Wys≈Çano " + data.length + " bajt√≥w, kolor: " + currentColor);
  }catch(e){
    log("B≈ÇƒÖd przy writeValue: " + e.message);
  }
}

/* ---------- G≈ÅOS ---------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog=null, isListening=false;

if(!SpeechRecognition){
  document.getElementById('voiceStatus').textContent="Brak obs≈Çugi Web Speech API (u≈ºyj Chrome / Edge przez HTTPS)";
  log("SpeechRecognition niedostƒôpne w tej przeglƒÖdarce");
}else{
  recog = new SpeechRecognition();
  recog.lang = 'pl-PL';
  recog.continuous = true;
  recog.interimResults = false;

  recog.onstart = ()=>{
    log("Rozpoznawanie g≈Çosu START");
  };

  recog.onresult = e=>{
    log("onresult: otrzymano " + e.results.length + " wynik√≥w");
    let fullText = "";
    for(let i=0;i<e.results.length;i++){
      fullText += e.results[i][0].transcript + " ";
    }
    fullText = fullText.toLowerCase().trim();
    log("Pe≈Çny transcript: " + fullText);
    document.getElementById('voiceStatus').textContent = "Rozpoznano: "+fullText;
    document.getElementById('voiceColorText').textContent = fullText;

    let detected = null;
    Object.keys(colorMap).forEach(key=>{
      if(fullText.includes(key)){
        detected = colorMap[key];
      }
    });

    if(detected){
      log("Wykryto kolor: " + detected);
      fill(detected);
      document.body.style.backgroundColor = detected;
    }else{
      log("Nie znaleziono ≈ºadnego koloru w tek≈õcie");
    }
  };

  recog.onerror = e => {
    document.getElementById('voiceStatus').textContent = "B≈ÇƒÖd: " + e.error;
    log("B≈ÇƒÖd rozpoznawania: " + e.error);
  };

  recog.onend = () => {
    log("Rozpoznawanie g≈Çosu END");
    if(isListening){
      log("Auto-restart rozpoznawania...");
      recog.start();
    }
  };

  document.getElementById('btnVoiceStart').onclick = async()=>{
    try{
      log("≈ªƒÖdanie dostƒôpu do mikrofonu...");
      await navigator.mediaDevices.getUserMedia({audio:true});
      isListening=true;
      recog.start();
      document.getElementById('btnVoiceStart').disabled=true;
      document.getElementById('btnVoiceStop').disabled=false;
      document.getElementById('voiceStatus').textContent="Nas≈Çuchiwanie...";
      log("Nas≈Çuchiwanie rozpoczƒôte");
    }catch(e){
      document.getElementById('voiceStatus').textContent="B≈ÇƒÖd mikrofonu: "+e.message;
      log("B≈ÇƒÖd mikrofonu: " + e.message);
    }
  };

  document.getElementById('btnVoiceStop').onclick = ()=>{
    isListening=false;
    recog.stop();
    document.getElementById('btnVoiceStart').disabled=false;
    document.getElementById('btnVoiceStop').disabled=true;
    document.getElementById('voiceStatus').textContent="Zatrzymano nas≈Çuchiwanie";
    log("Nas≈Çuchiwanie zatrzymane");
  };
}

/* ---------- WY≈öLIJ ---------- */
document.getElementById('btnSendGrid').onclick = sendGrid;
</script>
</body>
</html>

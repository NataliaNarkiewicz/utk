<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zmiana koloru głosem</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
      transition: background-color 0.3s;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
    }
    #status, #last {
      margin-top: 15px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Powiedz kolor, a tło się zmieni</h1>
  <button id="startBtn">Start nasłuchiwania</button>
  <button id="bleBtn">Połącz z ESP32 (BLE)</button>
  <div id="status">Mikrofon wyłączony</div>
  <div id="last">Ostatnio rozpoznane: —</div>

  <script>
    /* -------------------------------
       BLE – Twoje UUID
    --------------------------------*/
    const SERVICE_UUID = '12345678-1234-1234-1234-1234567890ab';
    const CHARACTERISTIC_UUID = '87654321-4321-4321-4321-0987654321ba';

    let bleDevice = null;
    let bleCharacteristic = null;

    async function connectBLE() {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });

        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        document.getElementById("status").textContent = "Połączono z ESP32 przez BLE";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "Błąd połączenia BLE";
      }
    }

    async function sendColorBLE(color) {
      if (!bleCharacteristic) {
        console.warn("Brak połączenia BLE");
        return;
      }

      const encoder = new TextEncoder();
      const data = encoder.encode(color);

      try {
        await bleCharacteristic.writeValue(data);
        console.log("Wysłano BLE:", color);
      } catch (err) {
        console.error("Błąd BLE:", err);
      }
    }

    // Obsługa różnych nazw interfejsu
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      alert("Twoja przeglądarka nie wspiera Web Speech API. Spróbuj w Google Chrome.");
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = "pl-PL";
      recognition.continuous = false;
      recognition.interimResults = false;

      const startBtn = document.getElementById("startBtn");
      const bleBtn = document.getElementById("bleBtn");
      const statusEl = document.getElementById("status");
      const lastEl = document.getElementById("last");

      // Mapowanie polskich nazw kolorów na CSS
      const colorMap = {
        "czerwony": "red",
        "zielony": "green",
        "niebieski": "blue",
        "żółty": "yellow",
        "zolty": "yellow",
        "biały": "white",
        "bialy": "white",
        "czarny": "black",
        "różowy": "pink",
        "rozowy": "pink",
        "pomarańczowy": "orange",
        "pomaranczowy": "orange",
        "fioletowy": "purple",
        "szary": "gray",
        "brązowy": "brown",
        "brazowy": "brown",
        "turkusowy": "turquoise"
      };

      function setBackgroundFromWord(word) {
        const lower = word.toLowerCase().trim();

        if (colorMap[lower]) {
          document.body.style.backgroundColor = colorMap[lower];
          return colorMap[lower];
        }

        const test = document.createElement("div");
        test.style.color = lower;
        if (test.style.color) {
          document.body.style.backgroundColor = lower;
          return lower;
        }

        return null;
      }

      startBtn.addEventListener("click", () => {
        recognition.start();
        statusEl.textContent = "Nasłuchiwanie… Powiedz nazwę koloru.";
      });

      bleBtn.addEventListener("click", connectBLE);

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        lastEl.textContent = "Ostatnio rozpoznane: " + transcript;

        const cssColor = setBackgroundFromWord(transcript);

        if (!cssColor) {
          statusEl.textContent = "Nie rozpoznano koloru: " + transcript;
        } else {
          statusEl.textContent = "Kolor ustawiony: " + cssColor;

          // WYSYŁAMY KOLOR DO ESP32 PRZEZ BLE
          sendColorBLE(cssColor);
        }
      };

      recognition.onerror = (event) => {
        statusEl.textContent = "Błąd rozpoznawania: " + event.error;
      };
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zmiana koloru gÅ‚osem + BLE</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
      transition: background-color 0.3s;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      margin: 10px;
    }
    #status, #last {
      margin-top: 15px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Powiedz kolor, a tÅ‚o siÄ™ zmieni</h1>
  <button id="startBtn">ðŸŽ¤ Start nasÅ‚uchiwania</button>
  <button id="bleBtn">ðŸ”µ PoÅ‚Ä…cz z ESP32 (BLE)</button>
  <div id="status">Mikrofon wyÅ‚Ä…czony</div>
  <div id="last">Ostatnio rozpoznane: â€”</div>

  <script>
    /* -----------------------------------
       BLE â€“ Twoje UUID (NIE ZMIENIAM)
    ----------------------------------- */
    const SERVICE_UUID = '12345678-1234-1234-1234-1234567890ab';
    const CHARACTERISTIC_UUID = '87654321-4321-4321-4321-0987654321ba';

    let bleDevice = null;
    let bleCharacteristic = null;

    async function connectBLE() {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });

        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        document.getElementById("status").textContent = "PoÅ‚Ä…czono z ESP32 przez BLE";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "BÅ‚Ä…d poÅ‚Ä…czenia BLE";
      }
    }

    async function sendColorBLE(color) {
      if (!bleCharacteristic) {
        console.warn("Brak poÅ‚Ä…czenia BLE");
        return;
      }

      const encoder = new TextEncoder();
      const data = encoder.encode(color);

      try {
        await bleCharacteristic.writeValue(data);
        console.log("WysÅ‚ano BLE:", color);
      } catch (err) {
        console.error("BÅ‚Ä…d BLE:", err);
      }
    }

    /* -----------------------------------
       Rozpoznawanie mowy
    ----------------------------------- */
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      alert("Twoja przeglÄ…darka nie wspiera Web Speech API. UÅ¼yj Google Chrome.");
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = "pl-PL";
      recognition.continuous = false;
      recognition.interimResults = false;

      const startBtn = document.getElementById("startBtn");
      const bleBtn = document.getElementById("bleBtn");
      const statusEl = document.getElementById("status");
      const lastEl = document.getElementById("last");

      const colorMap = {
        "czerwony": "red",
        "zielony": "green",
        "niebieski": "blue",
        "Å¼Ã³Å‚ty": "yellow",
        "zolty": "yellow",
        "biaÅ‚y": "white",
        "bialy": "white",
        "czarny": "black",
        "rÃ³Å¼owy": "pink",
        "rozowy": "pink",
        "pomaraÅ„czowy": "orange",
        "pomaranczowy": "orange",
        "fioletowy": "purple",
        "szary": "gray",
        "brÄ…zowy": "brown",
        "brazowy": "brown",
        "turkusowy": "turquoise"
      };

      function setBackgroundFromWord(word) {
        const lower = word.toLowerCase().trim();

        if (colorMap[lower]) {
          document.body.style.backgroundColor = colorMap[lower];
          return colorMap[lower];
        }

        const test = document.createElement("div");
        test.style.color = lower;
        if (test.style.color) {
          document.body.style.backgroundColor = lower;
          return lower;
        }

        return null;
      }

      startBtn.addEventListener("click", () => {
        recognition.start();
        statusEl.textContent = "NasÅ‚uchiwanieâ€¦ Powiedz nazwÄ™ koloru.";
      });

      bleBtn.addEventListener("click", connectBLE);

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        lastEl.textContent = "Ostatnio rozpoznane: " + transcript;

        const cssColor = setBackgroundFromWord(transcript);

        if (!cssColor) {
          statusEl.textContent = "Nie rozpoznano koloru: " + transcript;
        } else {
          statusEl.textContent = "Kolor ustawiony: " + cssColor;

          // WysyÅ‚amy kolor do ESP32 przez BLE
          sendColorBLE(cssColor);
        }
      };

      recognition.onerror = (event) => {
        statusEl.textContent = "BÅ‚Ä…d rozpoznawania: " + event.error;
      };
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LED Voice Control 9x9</title>

<style>
body {
  background:#111;
  color:white;
  font-family:Arial;
  margin:0;
  transition:background 0.3s;
}

header {
  background:#222;
  padding:1rem;
  text-align:center;
  font-size:1.5rem;
}

#grid {
  display:grid;
  grid-template-columns:repeat(9,40px);
  grid-template-rows:repeat(9,40px);
  gap:4px;
  justify-content:center;
  margin-top:20px;
}

.cell {
  width:40px;
  height:40px;
  background:black;
  border-radius:4px;
}

button {
  padding:0.7rem 1.2rem;
  margin:10px;
  background:#444;
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
}

#log {
  background:#000;
  padding:10px;
  margin-top:15px;
  font-size:0.8rem;
  max-height:150px;
  overflow:auto;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<header>ðŸŽ¤ Sterowanie gÅ‚osem LED 9Ã—9</header>

<div style="text-align:center;">
  <button id="btnBluetooth">PoÅ‚Ä…cz z ESP32</button>
  <button id="btnStart">Start nasÅ‚uchiwania</button>
  <button id="btnStop" disabled>Stop</button>
  <button id="btnSend">WyÅ›lij do LED</button>

  <p id="status">Status: nieaktywny</p>
  <p id="heard" style="font-size:1.4rem;font-weight:bold;"></p>
</div>

<div id="grid"></div>

<div id="log"></div>

<script>
/* ------------------ USTAWIENIA ------------------ */
const NUM_LEDS = 81;
let writeCharacteristic = null;
let currentColor = null;

/* ------------------ MAPA KOLORÃ“W ------------------ */
const colors = {
  red:[255,0,0],
  green:[0,255,0],
  blue:[0,0,255],
  yellow:[255,255,0],
  orange:[255,165,0],
  purple:[128,0,128],
  pink:[255,20,147],
  black:[0,0,0]
};

const colorWords = {
  "czerwony":"red","czerwona":"red",
  "zielony":"green","zielona":"green",
  "niebieski":"blue","niebieska":"blue",
  "Å¼Ã³Å‚ty":"yellow","zolty":"yellow",
  "pomaraÅ„czowy":"orange","pomaranczowy":"orange",
  "fioletowy":"purple",
  "rÃ³Å¼owy":"pink","rozowy":"pink",
  "czarny":"black"
};

/* ------------------ LOG ------------------ */
function log(msg){
  document.getElementById("log").textContent += msg + "\n";
}

/* ------------------ TWORZENIE SIATKI 9Ã—9 ------------------ */
const grid = document.getElementById("grid");
let cells = [];

for(let i=0;i<NUM_LEDS;i++){
  const div = document.createElement("div");
  div.className = "cell";
  grid.appendChild(div);
  cells.push(div);
}

/* ------------------ KOLOROWANIE SIATKI ------------------ */
function fillGrid(color){
  const rgb = colors[color];
  if(!rgb) return;

  cells.forEach(c=>{
    c.style.background = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
  });

  document.body.style.background = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
  currentColor = color;

  log("Ustawiono kolor: " + color);
}

/* ------------------ BLUETOOTH ------------------ */
const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
const CHAR_UUID    = "87654321-4321-4321-4321-0987654321ba";

document.getElementById("btnBluetooth").onclick = async () => {
  try {
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[SERVICE_UUID]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    writeCharacteristic = await service.getCharacteristic(CHAR_UUID);

    document.getElementById("status").textContent = "Status: poÅ‚Ä…czono z " + device.name;
    log("PoÅ‚Ä…czono z ESP32");
  } catch(e){
    log("BÅ‚Ä…d Bluetooth: " + e.message);
  }
};

/* ------------------ WYSYÅANIE DO ESP32 ------------------ */
document.getElementById("btnSend").onclick = async () => {
  if(!writeCharacteristic){
    alert("Najpierw poÅ‚Ä…cz z ESP32!");
    return;
  }
  if(!currentColor){
    alert("Najpierw powiedz kolor!");
    return;
  }

  const rgb = colors[currentColor];
  let data = new Uint8Array(NUM_LEDS * 3);

  for(let i=0;i<NUM_LEDS;i++){
    data[i*3]   = rgb[0];
    data[i*3+1] = rgb[1];
    data[i*3+2] = rgb[2];
  }

  await writeCharacteristic.writeValue(data);
  log("WysÅ‚ano kolor do ESP32: " + currentColor);
};

/* ------------------ ROZPOZNAWANIE GÅOSU ------------------ */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog = null;
let listening = false;

if(SpeechRecognition){
  recog = new SpeechRecognition();
  recog.lang = "pl-PL";
  recog.continuous = true;

  recog.onresult = e => {
    let text = e.results[e.resultIndex][0].transcript.toLowerCase();
    document.getElementById("heard").textContent = text;
    log("Rozpoznano: " + text);

    let found = null;
    Object.keys(colorWords).forEach(word=>{
      if(text.includes(word)) found = colorWords[word];
    });

    if(found){
      fillGrid(found);
    }
  };

  recog.onerror = e => log("BÅ‚Ä…d: " + e.error);
}

/* ------------------ START / STOP ------------------ */
document.getElementById("btnStart").onclick = async () => {
  await navigator.mediaDevices.getUserMedia({audio:true});
  listening = true;
  recog.start();
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnStop").disabled = false;
  document.getElementById("status").textContent = "Status: nasÅ‚uchiwanie...";
};

document.getElementById("btnStop").onclick = () => {
  listening = false;
  recog.stop();
  document.getElementById("btnStart").disabled = false;
  document.getElementById("btnStop").disabled = true;
  document.getElementById("status").textContent = "Status: zatrzymano";
};
</script>

</body>
</html>
